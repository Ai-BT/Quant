# 퀀트 트레이딩 시스템 아키텍처

## 1. 전체 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (React/Vue)                    │
│  - 전략 모니터링 대시보드                                        │
│  - 주문 내역 조회                                                │
│  - 수익률/통계 차트                                              │
│  - 전략 시작/중지 제어                                           │
└───────────────────────┬─────────────────────────────────────────┘
                        │ HTTP/WebSocket
                        │
┌───────────────────────▼─────────────────────────────────────────┐
│                    API Gateway (FastAPI)                        │
│  - REST API 엔드포인트                                           │
│  - WebSocket 연결 관리                                           │
│  - 인증/인가                                                     │
│  - 요청 검증 및 라우팅                                           │
└───────┬───────────┬───────────┬───────────┬───────────┬────────┘
        │           │           │           │           │
┌───────▼────────┐ ┌▼─────────┐┌▼─────────┐┌▼─────────┐┌▼────────┐
│ Strategy API   │ │ML Model  ││Order API ││Monitor   ││Auth API │
│ - 전략 CRUD     │ │API      ││- 주문 조회││API       ││- 인증   │
│ - 전략 실행     │ │- 모델 관리││- 주문 취소││- 상태    ││- 인가   │
│ - 백테스트      │ │- 학습 요청││- 잔고    ││- 알림    ││         │
│ - AI 전략 포함  │ │- 추론    ││- 거래내역││- 로그    ││         │
└───────┬────────┘ └────┬─────┘└────┬─────┘└────┬─────┘└─────────┘
        │               │           │           │
        └───────────────┼───────────┼───────────┘
                        │           │
        ┌───────────────▼───────────▼───────────┐
        │         Message Queue (Redis)         │
        │  - 전략 신호 큐                        │
        │  - 주문 요청 큐                        │
        │  - 이벤트 버스                         │
        │  - 모델 학습 작업 큐                   │
        └───────────────┬───────────┬───────────┘
                        │           │
        ┌───────────────▼───────────┴───────────┐
        │      Strategy Engine (Worker)         │
        │  - 전략 로직 실행                       │
        │  ├─ 전통 전략 (SMA, MACD, RSI 등)     │
        │  └─ AI 전략 (ML 모델 활용)             │
        │  - 시장 데이터 분석                     │
        │  - 매수/매도 신호 생성                  │
        │  - 신호를 큐에 전송                     │
        └───────────────────┬───────────────────┘
                            │
        ┌───────────────────▼───────────────────┐
        │      ML Model Service (Worker)        │
        │  - 모델 학습 워커                      │
        │  - 모델 추론 서비스                    │
        │  - 모델 버전 관리                      │
        │  - 모델 성능 평가                      │
        └───────────────────┬───────────────────┘
                            │
        ┌───────────────────▼───────────────────┐
        │      Order Executor (Worker)          │
        │  - 주문 큐에서 신호 수신               │
        │  - 리스크 관리 검증                    │
        │  - Upbit API 호출                      │
        │  - 주문 결과 DB 저장                   │
        └───────────────────┬───────────────────┘
                            │
        ┌───────────────────▼───────────────────┐
        │         External API (Upbit)          │
        │  - 주문 실행                           │
        │  - 잔고 조회                           │
        │  - 시장 데이터                         │
        └───────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      Data Layer                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  PostgreSQL  │  │    Redis     │  │   SQLite     │          │
│  │  - 주문 내역  │  │  - 캐시      │  │  - 초기 설정  │          │
│  │  - 전략 설정  │  │  - 세션      │  │  - 로컬 데이터│          │
│  │  - 거래 로그  │  │  - 큐        │  │              │          │
│  │  - 사용자     │  │  - Rate Limit│  │              │          │
│  │  - 모델 메타  │  │              │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Model Storage                                │   │
│  │  - 학습된 모델 파일 (파일 시스템 또는 S3)                 │   │
│  │  - 모델 아티팩트                                          │   │
│  │  - 모델 버전 관리 (MLflow 또는 자체 시스템)              │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 컴포넌트 상세 설명

### 2.1 Frontend (React/Vue)
- **역할**: 사용자 인터페이스 제공
- **기능**:
  - 실시간 대시보드 (WebSocket 연결)
  - 전략 모니터링 및 제어
  - 주문 내역 및 수익률 조회
  - 차트 및 통계 시각화
  - 전략 설정 및 백테스트 결과 확인

### 2.2 API Gateway (FastAPI)
- **역할**: 모든 HTTP 요청의 진입점
- **기능**:
  - REST API 엔드포인트 제공
  - WebSocket 연결 관리
  - 인증/인가 (JWT)
  - 요청 검증 및 라우팅
  - Rate Limiting

### 2.3 Strategy API
- **역할**: 전략 관련 API
- **기능**:
  - 전략 CRUD (생성, 조회, 수정, 삭제)
  - 전략 실행/중지
  - 백테스트 실행
  - 전략 성과 조회

### 2.4 Order API
- **역할**: 주문 관련 API
- **기능**:
  - 주문 내역 조회
  - 주문 취소
  - 잔고 조회
  - 거래 내역 조회

### 2.5 Monitor API
- **역할**: 모니터링 및 알림 API
- **기능**:
  - 실시간 시스템 상태
  - 알림 설정 및 조회
  - 로그 조회
  - 성능 메트릭

### 2.6 Message Queue (Redis)
- **역할**: 비동기 작업 큐
- **기능**:
  - 전략 신호 큐 (Strategy → Order Executor)
  - 주문 요청 큐
  - 이벤트 버스 (실시간 알림)
  - Rate Limit 관리

### 2.7 Strategy Engine (Worker)
- **역할**: 전략 로직 실행
- **기능**:
  - 시장 데이터 수집 및 분석
  - 전략 로직 실행
    - 전통 전략: SMA, MACD, RSI 등 기술적 지표 기반
    - AI 전략: ML 모델 추론 결과 기반
  - 매수/매도 조건 판단 및 신호 생성
  - 신호를 큐에 전송
  - 전략 상태 관리

### 2.10 ML Model Service (Worker)
- **역할**: AI 모델 관리 및 추론
- **기능**:
  - 모델 학습 작업 실행
  - 모델 추론 서비스 제공
  - 모델 버전 관리
  - 모델 성능 평가 및 비교
  - 모델 A/B 테스트

### 2.11 ML Model API
- **역할**: AI 모델 관련 API
- **기능**:
  - 모델 목록 조회
  - 모델 학습 요청
  - 모델 배포/활성화
  - 모델 성능 조회
  - 모델 히스토리 관리

### 2.8 Order Executor (Worker)
- **역할**: 실제 주문 실행
- **기능**:
  - 큐에서 주문 신호 수신
  - 리스크 관리 검증 (최대 손실, 포지션 크기 등)
  - Upbit API 호출
  - 주문 결과 DB 저장
  - 실패 시 재시도 로직

### 2.9 Data Layer
- **PostgreSQL**: 메인 데이터베이스
  - 주문 내역, 전략 설정, 거래 로그, 사용자 정보
- **Redis**: 캐시 및 큐
  - 시장 데이터 캐시, 세션, 메시지 큐, Rate Limit
- **SQLite**: 초기 설정 및 로컬 데이터 (선택사항)

## 3. 데이터 흐름

### 3.1 전략 실행 흐름 (전통 전략)
```
1. 사용자가 Frontend에서 전략 시작
2. Frontend → API Gateway (POST /api/strategies/{id}/start)
3. API Gateway → Strategy API
4. Strategy API → DB (전략 상태 업데이트)
5. Strategy API → Message Queue (전략 실행 이벤트)
6. Strategy Engine Worker가 큐에서 이벤트 수신
7. Strategy Engine이 시장 데이터 수집 및 분석
8. 전략 로직 실행 (기술적 지표 계산)
9. 매수/매도 신호 발생 시 → Message Queue (주문 신호)
10. Order Executor Worker가 큐에서 신호 수신
11. Order Executor가 리스크 검증 후 Upbit API 호출
12. 주문 결과 → DB 저장
13. 주문 결과 → Redis (이벤트 버스)
14. Frontend가 WebSocket을 통해 실시간 업데이트 수신
```

### 3.1-2 전략 실행 흐름 (AI 전략)
```
1. 사용자가 Frontend에서 AI 전략 시작
2. Frontend → API Gateway (POST /api/strategies/{id}/start)
3. API Gateway → Strategy API
4. Strategy API → DB (전략 상태 업데이트)
5. Strategy API → Message Queue (전략 실행 이벤트)
6. Strategy Engine Worker가 큐에서 이벤트 수신
7. Strategy Engine이 시장 데이터 수집 및 전처리
8. Strategy Engine → ML Model Service (추론 요청)
9. ML Model Service가 학습된 모델 로드 및 추론
10. 추론 결과 (매수/매도 확률 또는 신호) 반환
11. Strategy Engine이 추론 결과 기반으로 신호 생성
12. 매수/매도 신호 발생 시 → Message Queue (주문 신호)
13. Order Executor Worker가 큐에서 신호 수신
14. Order Executor가 리스크 검증 후 Upbit API 호출
15. 주문 결과 → DB 저장
16. 주문 결과 → Redis (이벤트 버스)
17. Frontend가 WebSocket을 통해 실시간 업데이트 수신
```

### 3.1-3 모델 학습 흐름
```
1. 사용자가 Frontend에서 모델 학습 요청
2. Frontend → API Gateway (POST /api/models/train)
3. API Gateway → ML Model API
4. ML Model API → DB (학습 작업 상태 저장)
5. ML Model API → Message Queue (학습 작업 큐)
6. ML Model Service Worker가 큐에서 작업 수신
7. 과거 시장 데이터 수집 및 전처리
8. 특성 추출 (Feature Engineering)
9. 모델 학습 (LSTM, Transformer, XGBoost 등)
10. 모델 평가 및 검증
11. 모델 저장 및 버전 관리
12. 모델 메타데이터 → DB 저장
13. 학습 결과 → Redis (이벤트 버스)
14. Frontend가 WebSocket을 통해 학습 완료 알림 수신
```

### 3.2 실시간 모니터링 흐름
```
1. Frontend가 WebSocket 연결
2. Strategy Engine / Order Executor가 이벤트 발생
3. 이벤트 → Redis (Pub/Sub)
4. API Gateway가 Redis 구독
5. API Gateway → Frontend (WebSocket)
6. Frontend가 UI 업데이트
```

## 4. 핵심 설계 원칙

### 4.1 전략과 주문 실행 분리
- **Strategy Engine**: 순수한 전략 로직만 담당 (비즈니스 로직)
- **Order Executor**: 실제 주문 실행만 담당 (인프라 로직)
- **장점**: 
  - 전략 로직 변경 시 주문 로직 영향 없음
  - 백테스트와 실제 거래 로직 재사용 가능
  - 각 컴포넌트 독립적 테스트 가능

### 4.2 비동기 처리
- Message Queue를 통한 비동기 처리
- Worker가 독립적으로 동작
- 장점: 시스템 안정성, 확장성, 장애 격리

### 4.3 무중단 운영
- Worker 프로세스 자동 재시작 (Supervisor/Systemd)
- Docker 기반 컨테이너 오케스트레이션
- Health Check 및 모니터링
- 장애 시 자동 복구

### 4.4 확장성
- Worker 수평 확장 가능
- Redis를 통한 분산 처리
- 마이크로서비스 아키텍처
- 모델 학습 및 추론 독립적 스케일링

### 4.5 AI/ML 통합
- **전통 전략과 AI 전략 공존**: 기술적 지표 기반 전략과 ML 모델 기반 전략 모두 지원
- **하이브리드 전략**: 전통 전략과 AI 전략 결과를 조합하여 사용 가능
- **모델 버전 관리**: 여러 모델 버전을 관리하고 A/B 테스트 가능
- **자동 재학습**: 주기적으로 모델 재학습 및 성능 평가
- **특성 엔지니어링**: 시장 데이터에서 효과적인 특성 추출

